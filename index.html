<!doctype html><meta charset="utf-8"><title>Score Prototype</title>
<style>
#ui{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
#ui button{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f7f7f7;cursor:pointer;font-size:20px}
</style>

<div id="ui">
  <button data-dur="32">○</button>
  <button data-dur="16">𝅗𝅥</button>
  <button data-dur="8">♩</button>
  <button data-dur="4">♪</button>
  <button data-dur="2">𝅘𝅥𝅯</button>
  <button data-dur="1">𝅘𝅥𝅰</button>
</div>
<div id="score"></div>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js"></script>
<script>
// ----- state -----
const beats=4, beatType=4, divisions=8; 
const MEASURE_MAX=beats*(divisions*4/beatType); 
let measures=[[]];
let curDur=8, curDot=false;

const el=document.getElementById('score');
const osmd=new opensheetmusicdisplay.OpenSheetMusicDisplay(el,{backend:"svg",drawTitle:false});

// ----- helpers -----
function measTime(m){return m.reduce((s,n)=>s+n.dur,0)}
function pushMeasure(){measures.push([])}
function addNote(step){
  let m=measures[measures.length-1];
  let dur=curDur;
  if(curDot) dur += curDur/2; // dotted
  if(measTime(m)+dur>MEASURE_MAX){pushMeasure(); m=measures[measures.length-1];}
  m.push({step,oct:4,dur,rest:!step});
  curDot=false;
  render();
}
function typeOf(d){
  if(d===48) return "dotted-half";
  switch(d){
    case 32: return 'whole';
    case 16: return 'half';
    case 8: return 'quarter';
    case 4: return 'eighth';
    case 2: return '16th';
    case 1: return '32nd';
    case 12: return 'dotted-quarter';
    case 24: return 'dotted-half';
    default: return 'quarter';
  }
}
function noteXml(n){
  if(n.rest) return `<note><rest/><duration>${n.dur}</duration><type>${typeOf(n.dur)}</type></note>`;
  return `<note>
    <pitch><step>${n.step}</step><octave>${n.oct}</octave></pitch>
    <duration>${n.dur}</duration><type>${typeOf(n.dur)}</type>
  </note>`;
}
function buildXml(){
  const attrs=`<attributes>
    <divisions>${divisions}</divisions>
    <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
    <clef><sign>G</sign><line>2</line></clef>
  </attributes>`;
  const ms=measures.map((m,i)=>`<measure number="${i+1}">${i===0?attrs:''}${m.map(noteXml).join('')}</measure>`).join('');
  return `<?xml version="1.0" encoding="UTF-8"?>
  <score-partwise version="3.1">
    <part-list><score-part id="P1"><part-name>Guitar</part-name></score-part></part-list>
    <part id="P1">${ms}</part>
  </score-partwise>`;
}
async function render(){await osmd.load(buildXml()); osmd.render();}

// ----- UI events -----
document.querySelectorAll('#ui button').forEach(b=>b.onclick=()=>{curDur=+b.dataset.dur;curDot=false;});

// Keyboard input
document.addEventListener('keydown',e=>{
  const key=e.key.toLowerCase();
  if("cdefgab".includes(key)){ addNote(key.toUpperCase()); }
  else if("123456".includes(key)){
    const map={1:32,2:16,3:8,4:4,5:2,6:1};
    curDur=map[key]; curDot=false;
  }
  else if(key==="."){ curDot=true; }
});

render();
</script>
